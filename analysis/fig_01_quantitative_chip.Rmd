---
title: "Figure 1. Global histone levels."
output:
  workflowr::wflow_html:
    code_folding: show
editor_options:
  chunk_output_type: console
params:
  datadir: "./data/"
  chromhmm: "./data/bed/E008_15_coreMarks_hg38lift_noblock_fullnames.bed"
---

# Summary

Supplementary code for panel 1 figures.

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(wigglescout)
library(ggplot2)
library(reshape2)
library(dplyr)
library(ggpubr)
library(ggrastr)
library(knitr)
library(rtracklayer)

my_svg <- function(file, width, height) {
  library(svglite)
  svglite(file = file, width = width, height = height, bg = "white")
}

knitr::opts_chunk$set(dev = c('png', 'my_svg'), fig.ext = c("png", "svg"), fig.width = 8, fig.height = 8)
source("./code/embed_functions.R")
source("./code/globals.R")

dir.create("./figures_data")
dir.create("./output")
```

## Helper functions

```{r helper-functions, class.source = NULL}
#' Calculate INRC from a mapped read counts table, and append such values
#' to it.
#'
#' @param counts Counts table. Corresponding file is provided as part of the 
#'   included metadata.
#' @param selector Counts column used. Final_mapped represents the final number
#'   of reads after deduplication and blacklisting.

#' @return A table including INRC and INRC norm to naive reference
calculate_inrc <- function(counts, selector = "final_mapped") {
  counts$condition <- paste(counts$celltype, counts$treatment, sep="_")
  
  inputs <- counts[counts$ip == "Input", c("library", selector)]
  colnames(inputs) <- c("library", "input_reads")
  
  non_inputs <- counts[counts$ip != "Input",]
  counts <- merge(non_inputs, inputs, by.x="input", by.y="library")
  counts$inrc <- counts[, selector] / counts[, "input_reads"]
  
  references <- counts[grepl("_Ni_pooled", counts$library), c("ip", "inrc")]
  colnames(references) <- c("ip", "ref_inrc")
  
  counts <- merge(counts, references, by="ip")
  counts$norm_to_naive <- counts$inrc / counts$ref_inrc
  
  id_vars <- c("ip", "treatment", "celltype", "condition", "replicate", "norm_to_naive")
  inrc <- counts[, c(id_vars)]
  
  inrc$condition <- factor(
    inrc$condition,
    levels = c(
      "Naive_Untreated",
      "Primed_Untreated",
      "Naive_EZH2i",
      "Primed_EZH2i"
    )
  )
  
  inrc
}

#' Barplot INRC pooled vs replicates per condition
#'
#' @param inrc Table with the INRC values
#' @param ip Which IP to plot
#' @param colors Corresponding colors
inrc_barplot <- function(inrc, ip, colors, font = 16) {
  inrc <- inrc[inrc$ip == ip, ]
  
  # So paired test takes right replicates
  inrc <- inrc[order(inrc$condition, inrc$replicate), ]
  
  max_v <- max(abs(inrc$norm_to_naive))
  
  aesthetics <- aes(x = .data[["condition"]],
                    y = .data[["norm_to_naive"]],
                    color = .data[["condition"]])
  
  my_comp <- list(c("Naive_Untreated", "Primed_Untreated"),
                  c("Naive_Untreated", "Naive_EZH2i"),
                  c("Primed_Untreated", "Primed_EZH2i"),
                  c("Naive_EZH2i", "Primed_EZH2i"))
  
  stats_method <- "t.test"
  
  ggplot(inrc[inrc$replicate != 'pooled',], aesthetics) +
    geom_point() +
    stat_compare_means(
      method = stats_method,
      paired = TRUE,
      comparisons = my_comp,
      label = "p.format"
    ) +
    geom_bar(
      data = inrc[inrc$replicate == 'pooled',],
      stat = 'identity',
      alpha = 0.6,
      aes(fill = condition)
    ) +
    scale_fill_manual(values = colors) +
    scale_color_manual(values = colors) +
    labs(
      x = "",
      y = 'INRC fraction vs Naïve',
      title = paste(ip, "MINUTE-ChIP"),
      caption = paste(stats_method, "signif. test, paired")
    ) +
    theme_classic(base_size = font) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ylim(0, 1.5)
}

colors_list <- c("Naive_EZH2i"="#82c5c6",
                 "Naive_Untreated"="#278b8b",
                 "Primed_EZH2i"="#f49797",
                 "Primed_Untreated"="#f44b34")

```

# Global read counts

## H2AUb levels

```{r h2aub-inrc-barplot, fig.height = 8, fig.width = 8}
counts_file <- file.path(params$datadir, "meta", "Kumar_2020_stats_summary.csv")
counts <- read.table(counts_file, sep="\t", header = T, na.strings = "NA", stringsAsFactors = F)

inrc <- calculate_inrc(counts) 
ip <- "H2Aub"

inrc_barplot(inrc, "H2Aub", colors_list)
```

You can download data values here: `r embed_last_plot_data(name="H2AUb_global.tsv")`.

## H3K27m3 levels

```{r h3k27m3-inrc-barplot, fig.height = 8, fig.width = 8}
inrc_barplot(inrc, "H3K27m3", colors_list)
```

You can download data values here: `r embed_last_plot_data(name="H3K27m3_global.tsv")`.

## H3K4m3 levels

```{r h3k4m3-inrc-barplot, fig.height = 8, fig.width = 8}
inrc_barplot(inrc, "H3K4m3", colors_list)
```

You can download data values here: `r embed_last_plot_data(name="H3K4m3_global.tsv")`.

# ChromHMM global

Here global average per ChromHMM categories are shown.

## H3K27m3

```{r chromhmm-h3k27m3, fig.width = 13, fig.height = 14}
bwfiles <- list.files(file.path(params$datadir, "bw/Kumar_2020"), pattern = "H3K27m3.*pooled.*hg38.scaled", full.names = T)
labels <- gsub("_pooled.hg38.scaled.bw", "", basename(bwfiles))
labels <- gsub("_H9", "", labels)

chromhmm <- params$chromhmm

plot_bw_loci_summary_heatmap(bwfiles, chromhmm, labels = labels, remove_top=0.001)
```

You can download data values here: `r embed_last_plot_data(name="H3K27m3_chromhmm.tsv")`.

## H3K4m3

```{r chromhmm-h3k4m3, fig.width = 13, fig.height = 14}
bwfiles <- list.files(file.path(params$datadir, "bw/Kumar_2020"), pattern = "H3K4m3.*pooled.*hg38.scaled", full.names = T)
labels <- gsub("_pooled.hg38.scaled.bw", "", basename(bwfiles))
labels <- gsub("_H9", "", labels)

plot_bw_loci_summary_heatmap(bwfiles, chromhmm, labels = labels, remove_top=0.001)
```

You can download data values here: `r embed_last_plot_data(name="H3K4m3_chromhmm.tsv")`.

## H2AUb

```{r chromhmm-h2aub, fig.width = 13, fig.height = 14}
bwfiles <- list.files(file.path(params$datadir, "bw/Kumar_2020"), pattern = "H2Aub.*pooled.*hg38.scaled", full.names = T)
labels <- gsub("_pooled.hg38.scaled.bw", "", basename(bwfiles))
labels <- gsub("_H9", "", labels)

chromhmm <- params$chromhmm

plot_bw_loci_summary_heatmap(bwfiles, chromhmm, labels = labels, remove_top=0.001)
```

You can download data values here: `r embed_last_plot_data(name="H2Aub_chromhmm.tsv")`.

# Genome-wide 10kb bins

## H3K27m3 Naïve vs Primed

```{r h3k27m3-ni-vs-pr-10kb-bins, warning = F, fig.width = 5, fig.height = 5}
bins_table <- "./data/meta/Kumar_2020_master_bins_10kb_table_final_raw.tsv"
bins <- read.table(bins_table, header = T, sep = "\t")
points_color <- "#112233"
points_shape <- "."
raster_dpi <- 300

ggplot(bins, aes(x=log2(H3K27m3_Ni_mean_cov), y=log2(H3K27m3_Pr_mean_cov))) +
    rasterise(geom_point(size = 1, alpha = 0.2, color = points_color, shape = points_shape), dpi = raster_dpi) +
    geom_density2d(binwidth = 0.1) +
    geom_abline(slope = 1, linetype = "dashed") +
    theme_default() +
    labs(x = "Log2 H3K27m3 Naïve - FPGC",
         y = "Log2 H3K27m3 Primed - FPGC", title = "H3K27m3", subtitle = "10kb bins") + 
    coord_cartesian(xlim = c(-8, 8), ylim = c(-8, 8))
```

## H2AUb Naïve vs Primed

```{r h2aub-ni-vs-pr-10kb-bins, warning = F, fig.width = 5, fig.height = 5}
ggplot(bins, aes(x=log2(H2Aub_Ni_mean_cov), y=log2(H2Aub_Pr_mean_cov))) +
    rasterise(geom_point(size = 1, alpha = 0.2, color = "#2f1547", shape = points_shape), dpi = raster_dpi) +
    geom_abline(slope = 1, linetype = "dashed") +
    geom_density2d(binwidth = 0.1) +
    theme_default() +
    labs(x = "Log2 H2Aub Naïve - FPGC",
         y = "Log2 H2Aub Primed - FPGC", title = "H2Aub", subtitle = "10kb bins") + 
    coord_cartesian(xlim = c(-8, 8), ylim = c(-8, 8))
```

## H3K4m3 Naïve vs Primed

```{r h3k4m3-ni-vs-pr-10kb-bins, warning = F, fig.width = 5, fig.height = 5}
ggplot(bins, aes(x=log2(H3K4m3_Ni_mean_cov), y=log2(H3K4m3_Pr_mean_cov))) +
    rasterise(geom_point(size = 1, alpha = 0.2, color = "#614925", shape = points_shape), dpi = raster_dpi) +
    geom_abline(slope = 1, linetype = "dashed") +
    geom_density2d(binwidth = 0.1) +
    theme_default() +
    labs(x = "Log2 H3K4m3 Naïve - FPGC",
         y = "Log2 H3K4m3 Primed - FPGC", title = "H3K4m3", subtitle = "10kb bins") + 
    coord_cartesian(xlim = c(-8, 8), ylim = c(-8, 8))
```

## H2Aub EZH2i vs Naïve

```{r h2aub-ezh2i-vs-ni-10kb-bins, warning = F, fig.width = 5, fig.height = 5}
genes_file <- "./data/bed/Kumar_2020/Kumar_2020_genes_hg38_UCSC.bed"
court_file <- "./data/bed/Bivalent_Court2017.hg38.bed"
genes_tss <- promoters(import(genes_file), upstream = 2500, downstream = 2500)
court_peaks <- import(court_file)
court_tss <- subsetByOverlaps(genes_tss, court_peaks)
bins_gr <- makeGRangesFromDataFrame(bins, keep.extra.columns = T)
bivalent_bins <- subsetByOverlaps(bins_gr, court_tss)
bivalent_df <- data.frame(bivalent_bins)
signif_df <- bins %>% filter(as.numeric(H2Aub_DS_EZH2i_vs_Ni_padj) < 0.05)

ggplot(bins, aes(x=log2(H2Aub_Ni_mean_cov), y=log2(H2Aub_Ni_EZH2i_mean_cov))) +
    rasterise(geom_point(size = 1, alpha = 0.2, color = "#2f1547", shape = points_shape), dpi = raster_dpi) +
    rasterise(geom_point(data=signif_df, size = 1.2, alpha = 0.8, color = "#d4797f", shape = points_shape), dpi = raster_dpi) +
    rasterise(geom_point(data=bivalent_df, size = 1.2, alpha = 0.8, color = "#4dbfb4", shape = points_shape), dpi = raster_dpi) +
    geom_abline(slope = 1, linetype = "dashed") +
    theme_default() +
    labs(x = "Log2 H2Aub Naïve - FPGC",
         y = "Log2 H2Aub Naïve + EZH2i - FPGC", title = "H2Aub", subtitle = "10kb bins") + 
    coord_cartesian(xlim = c(-8, 8), ylim = c(-8, 8))
```


